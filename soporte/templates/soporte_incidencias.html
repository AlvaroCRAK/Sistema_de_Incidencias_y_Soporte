{% extends "soporte_barra_lateral.html" %}

{% block title %}Incidencias{% endblock title %}

{% block content %}
    <div class="container mx-auto mt-5"> <!-- Agregado un contenedor para el espaciado -->
        <h2 class="text-2xl font-bold mb-4">NUEVAS INCIDENCIAS</h2>

        <div id="incidencias-list">
            {% for incidencia in incidencias %}
                <div class="incidencia bg-white rounded-lg shadow p-4 mb-6" data-id="{{ incidencia.id }}">
                    <p class="font-bold mb-2">Incidencia [{{ incidencia.fecha|date:"H:i:s" }}]</p>
                    <p><span class="font-semibold">Aula:</span> {{ incidencia.salon }}</p>
                    <p><span class="font-semibold">Categoría:</span> {{ incidencia.tipo_incidencia }}</p>
                    <p><span class="font-semibold">Descripción:</span> {{ incidencia.descripcion_estado }}</p>
                    
                    <!-- Campo para observaciones -->
                </div<!-- Dentro de la sección de "Observaciones" -->
              <div class="mb-4">
                  <label for="observaciones-{{ incidencia.id }}" class="block font-semibold">Observaciones:</label>
                  <textarea id="observaciones-{{ incidencia.id }}" name="observaciones" class="border rounded w-full p-2" rows="3"></textarea>
              </div>

              <div class="mt-4 flex space-x-2">
                  <form method="POST" action="{% url 'soporte:incidencias' %}" onsubmit="handleSubmit(event, this)">
                      {% csrf_token %}
                      <input type="hidden" name="incidencia_id" value="{{ incidencia.id }}">
                      <input type="hidden" name="accion" value="atender">
                      <input type="hidden" name="observaciones" id="input-observaciones-{{ incidencia.id }}">
                      <button type="submit" class="bg-[#15bf40] text-white font-bold py-2 px-4 rounded hover:bg-[#0e9b35] transition duration-200">Atender</button>
                  </form>
                  <form method="POST" action="{% url 'soporte:incidencias' %}" onsubmit="handleSubmit(event, this)">
                      {% csrf_token %}
                      <input type="hidden" name="incidencia_id" value="{{ incidencia.id }}">
                      <input type="hidden" name="accion" value="archivar">
                      <input type="hidden" name="observaciones" id="input-observaciones-{{ incidencia.id }}">
                      <button type="submit" class="bg-[#ff3c3c] text-white font-bold py-2 px-4 rounded hover:bg-red-600 transition duration-200">Archivar</button>
                    </form>
                </div>>
            {% endfor %}
        </div>
    </div>

    <script>
        function handleSubmit(event, form) {
            // Evitar el envío predeterminado del formulario
            event.preventDefault(); 

            // Deshabilita todos los botones en el formulario
            const buttons = form.querySelectorAll('button');
            buttons.forEach(button => {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed'); // Estilos para indicar que están deshabilitados
                button.innerText = 'Procesando...'; // Cambia el texto del botón
            });

            // Obtener el ID de la incidencia desde el formulario
            const incidenciaId = form.querySelector('input[name="incidencia_id"]').value;

            // Obtener el valor de las observaciones
            const observaciones = document.getElementById(`observaciones-${incidenciaId}`).value;

            // Agregar el valor de las observaciones al formulario
            const inputObservaciones = form.querySelector('input[name="observaciones"]');
            inputObservaciones.value = observaciones;

            // Enviar el formulario usando fetch
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}', // Agregar el token CSRF
                },
            })
            .then(response => {
                if (response.ok) {
                    // Eliminar la incidencia de la lista
                    const incidenciaElement = document.querySelector(`.incidencia[data-id="${incidenciaId}"]`);
                    if (incidenciaElement) {
                        incidenciaElement.remove(); // Elimina el elemento del DOM
                    }
                } else {
                    console.error('Error al procesar la incidencia');
                }
            })
            .catch(error => {
                console.error('Error en la solicitud:', error);
            });
        }
    </script>
{% endblock content %}

